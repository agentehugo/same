<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAME - HOSP. DE URG√äNCIA DE GOI√ÅS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        /* [MANTENHA TODOS OS ESTILOS ANTERIORES] */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        /* ... (todos os outros estilos permanecem iguais) ... */
        
    </style>
</head>
<body>
    <!-- Status da Conex√£o -->
    <div id="connectionStatus" class="connection-status" style="display: none;">
        <i class="fas fa-circle me-1"></i>
        <span id="connectionText">Conectando...</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(0,0,0,0.5); z-index: 9999; display: none;">
        <div class="bg-white rounded p-4 text-center">
            <div class="spinner-border text-primary mb-3"></div>
            <p class="mb-0" id="loadingMessage">Processando...</p>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="container">
        <div class="login-container">
            <div class="hospital-header text-center mb-4">
                <h2><i class="fas fa-hospital-alt me-2"></i>SAME</h2>
                <p class="mb-0">HOSP. DE URG√äNCIA DE GOI√ÅS</p>
            </div>
            <div class="alert alert-info mb-3">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    Sistema integrado com Google Sheets. Os dados ser√£o sincronizados automaticamente.
                </small>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginUser" class="form-label">Usu√°rio</label>
                    <input type="text" class="form-control" id="loginUser" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
            </form>
            <button type="button" onclick="testarIntegracaoGoogleSheets()" class="btn btn-outline-info w-100 mt-2">
                <i class="fas fa-vial"></i> Testar Conex√£o Google Sheets
            </button>
            <button type="button" onclick="usarModoOffline()" class="btn btn-outline-warning w-100 mt-2">
                <i class="fas fa-wifi-slash"></i> Usar Modo Offline
            </button>
        </div>
    </div>

    <!-- [O RESTANTE DO HTML PERMANECE IGUAL] -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =============================================
        // CONFIGURA√á√ïES DO GOOGLE SHEETS - CORRIGIDAS
        // =============================================
        const SPREADSHEET_ID = '1OEqh24L8mtMYkf1j8bAn7Q1GZjPqUrUNuY_ySau_5p4'; // SUBSTITUA COM SEU ID REAL
        const API_KEY = 'AIzaSyB9TcVJoCR2A2AICG9oH7owHn2bMiBmhlM'; // SUBSTITUA COM SUA API KEY REAL
        
        let gapiInicializado = false;
        let ultimaSincronizacao = null;
        let modoOffline = false;

        // =============================================
        // SISTEMA DE LOGS - CORRIGIDO
        // =============================================
        const sistemaLogs = {
            logs: [],
            
            adicionarLog: function(acao, detalhes, tipo = 'info') {
                const log = {
                    timestamp: new Date().toISOString(),
                    usuario: usuarioLogado ? usuarioLogado.usuario : 'Sistema',
                    acao,
                    detalhes,
                    tipo
                };
                
                this.logs.push(log);
                console.log(`[${tipo.toUpperCase()}] ${acao}: ${detalhes}`);
                
                // Manter apenas os √∫ltimos 100 logs
                if (this.logs.length > 100) {
                    this.logs.shift();
                }
                
                // Salvar logs no localStorage
                this.salvarLogsLocal();
            },
            
            salvarLogsLocal: function() {
                try {
                    localStorage.setItem('logs_same', JSON.stringify(this.logs));
                } catch (error) {
                    console.error('Erro ao salvar logs:', error);
                }
            },
            
            carregarLogsLocal: function() {
                try {
                    const logsSalvos = localStorage.getItem('logs_same');
                    if (logsSalvos) {
                        this.logs = JSON.parse(logsSalvos);
                    }
                } catch (error) {
                    console.error('Erro ao carregar logs:', error);
                }
            },
            
            exportarLogs: function() {
                const dataStr = JSON.stringify(this.logs, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `logs_same_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                this.adicionarLog('EXPORTAR_LOGS', 'Logs exportados com sucesso', 'info');
                mostrarMensagem('Logs exportados com sucesso!', 'success');
            },
            
            limparLogs: function() {
                if (confirm('Tem certeza que deseja limpar todos os logs?')) {
                    this.logs = [];
                    localStorage.removeItem('logs_same');
                    this.adicionarLog('LIMPAR_LOGS', 'Todos os logs foram limpos', 'warning');
                    mostrarMensagem('Logs limpos com sucesso!', 'success');
                }
            }
        };

        // =============================================
        // FUN√á√ïES DE LOADING - CORRIGIDAS
        // =============================================
        function mostrarLoading(mensagem = 'Processando...') {
            document.getElementById('loadingMessage').textContent = mensagem;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function esconderLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // =============================================
        // INICIALIZA√á√ÉO CORRIGIDA
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Iniciando sistema SAME...');
            
            // Carregar logs do sistema
            sistemaLogs.carregarLogsLocal();
            sistemaLogs.adicionarLog('SISTEMA_INICIADO', 'Sistema SAME inicializado', 'info');
            
            // Inicializar Google API de forma ass√≠ncrona
            setTimeout(() => {
                inicializarGoogleAPI().catch(error => {
                    console.error('Falha na inicializa√ß√£o da API:', error);
                    sistemaLogs.adicionarLog('ERRO_INICIALIZACAO', `Falha: ${error.message}`, 'error');
                    
                    // Tentar carregar dados locais
                    carregarDadosLocais();
                });
            }, 1000);
            
            // Configura√ß√µes b√°sicas do sistema
            inicializarSistemaBasico();
            
            sistemaLogs.adicionarLog('INICIALIZACAO_COMPLETA', 'Sistema b√°sico inicializado', 'success');
        });

        // =============================================
        // INICIALIZA√á√ÉO DO GOOGLE API - CORRIGIDA
        // =============================================
        async function inicializarGoogleAPI() {
            return new Promise((resolve, reject) => {
                console.log('üîÑ Iniciando Google API...');
                
                // Timeout para evitar travamento
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout na inicializa√ß√£o da API Google'));
                }, 10000);

                try {
                    gapi.load('client', {
                        callback: async () => {
                            try {
                                console.log('üìö Google client carregado, inicializando...');
                                
                                await gapi.client.init({
                                    apiKey: 'AIzaSyB9TcVJoCR2A2AICG9oH7owHn2bMiBmhlM',
                                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                                });
                                
                                clearTimeout(timeout);
                                gapiInicializado = true;
                                modoOffline = false;
                                
                                console.log('‚úÖ Google API inicializada com sucesso');
                                sistemaLogs.adicionarLog('GOOGLE_API_INICIADA', 'API Google Sheets inicializada com sucesso', 'success');
                                
                                atualizarStatusConexao(true);
                                mostrarMensagem('‚úÖ Conectado ao Google Sheets!', 'success');
                                
                                // Tentar carregar dados do Google Sheets
                                await carregarDadosSheets();
                                
                                resolve();
                            } catch (error) {
                                clearTimeout(timeout);
                                console.error('‚ùå Erro na inicializa√ß√£o do cliente:', error);
                                reject(error);
                            }
                        },
                        onerror: () => {
                            clearTimeout(timeout);
                            console.error('‚ùå Erro ao carregar Google client');
                            reject(new Error('Falha ao carregar Google client'));
                        },
                        timeout: 10000
                    });
                } catch (error) {
                    clearTimeout(timeout);
                    reject(error);
                }
            });
        }

        // =============================================
        // FUN√á√ÉO PARA USAR MODO OFFLINE
        // =============================================
        function usarModoOffline() {
            modoOffline = true;
            gapiInicializado = false;
            
            sistemaLogs.adicionarLog('MODO_OFFLINE', 'Usu√°rio escolheu modo offline', 'warning');
            mostrarMensagem('üîå Modo offline ativado. Trabalhando com dados locais.', 'warning');
            
            // Carregar dados locais
            carregarDadosLocais();
            
            // Esconder loading se estiver vis√≠vel
            esconderLoading();
            
            // Atualizar status
            atualizarStatusConexao(false);
        }

        // =============================================
        // CARREGAR DADOS LOCAIS - NOVA FUN√á√ÉO
        // =============================================
        function carregarDadosLocais() {
            console.log('üìÇ Carregando dados locais...');
            
            try {
                // Tentar carregar dados do localStorage
                const dadosSalvos = localStorage.getItem('dados_same');
                if (dadosSalvos) {
                    const dados = JSON.parse(dadosSalvos);
                    
                    if (dados.usuarios) usuarios = dados.usuarios;
                    if (dados.solicitacoes) solicitacoes = dados.solicitacoes;
                    if (dados.opcoesCadastro) opcoesCadastro = dados.opcoesCadastro;
                    if (dados.atividadesUsuario) atividadesUsuario = dados.atividadesUsuario;
                    
                    console.log('‚úÖ Dados locais carregados com sucesso');
                    sistemaLogs.adicionarLog('DADOS_LOCAIS_CARREGADOS', 'Dados locais carregados do localStorage', 'success');
                } else {
                    // Usar dados padr√£o
                    console.log('‚ÑπÔ∏è Usando dados padr√£o do sistema');
                    sistemaLogs.adicionarLog('DADOS_PADRAO', 'Usando dados padr√£o do sistema', 'info');
                }
                
                // Atualizar interface
                preencherListasOpcoes();
                atualizarSelectsFormulario();
                atualizarSelectsFiltros();
                preencherUsuariosHistorico();
                preencherTodosRegistros();
                atualizarTabelaUsuarios();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados locais:', error);
                sistemaLogs.adicionarLog('ERRO_DADOS_LOCAIS', `Erro: ${error.message}`, 'error');
            }
        }

        // =============================================
        // SALVAR DADOS LOCAIS - NOVA FUN√á√ÉO
        // =============================================
        function salvarDadosLocais() {
            try {
                const dados = {
                    usuarios: usuarios,
                    solicitacoes: solicitacoes,
                    opcoesCadastro: opcoesCadastro,
                    atividadesUsuario: atividadesUsuario,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('dados_same', JSON.stringify(dados));
                console.log('üíæ Dados salvos localmente');
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar dados locais:', error);
                sistemaLogs.adicionarLog('ERRO_SALVAR_LOCAL', `Erro: ${error.message}`, 'error');
            }
        }

        // =============================================
        // INICIALIZA√á√ÉO B√ÅSICA DO SISTEMA
        // =============================================
        function inicializarSistemaBasico() {
            console.log('‚öôÔ∏è Inicializando sistema b√°sico...');
            
            // Configurar data atual para campos de data
            const hoje = new Date().toISOString().split('T')[0];
            if (document.getElementById('dataSolicitacao')) {
                document.getElementById('dataSolicitacao').value = hoje;
                document.getElementById('periodoInicial').value = hoje;
                document.getElementById('periodoFinal').value = hoje;
            }
            
            // Preencher ano e m√™s automaticamente
            atualizarAnoMes();
            
            // Preencher anos no relat√≥rio (2020 a 2040)
            const relatorioAnoSelect = document.getElementById('relatorioAno');
            if (relatorioAnoSelect) {
                relatorioAnoSelect.innerHTML = '<option value="">Todos os anos</option>';
                for (let i = 2020; i <= 2040; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    relatorioAnoSelect.appendChild(option);
                }
            }
            
            // Preencher meses no relat√≥rio
            const meses = [
                "JANEIRO", "FEVEREIRO", "MAR√áO", "ABRIL", "MAIO", "JUNHO",
                "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
            ];
            
            const relatorioMesSelect = document.getElementById('relatorioMes');
            if (relatorioMesSelect) {
                relatorioMesSelect.innerHTML = '<option value="">Todos os meses</option>';
                meses.forEach(mes => {
                    const option = document.createElement('option');
                    option.value = mes;
                    option.textContent = mes;
                    relatorioMesSelect.appendChild(option);
                });
            }
            
            // Event Listeners b√°sicos
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', fazerLogin);
            }
            
            // Outros event listeners ser√£o configurados ap√≥s o login
            console.log('‚úÖ Sistema b√°sico inicializado');
        }

        // =============================================
        // FUN√á√ïES DO GOOGLE SHEETS - CORRIGIDAS
        // =============================================
        async function carregarDadosSheets() {
            if (!gapiInicializado || modoOffline) {
                console.log('üì° Modo offline ou API n√£o inicializada - pulando carregamento do Sheets');
                return;
            }

            try {
                console.log('üì• Carregando dados do Google Sheets...');
                sistemaLogs.adicionarLog('CARREGAR_DADOS_SHEETS', 'Iniciando carregamento de dados do Sheets', 'info');

                // Carregar solicita√ß√µes
                const responseSolicitacoes = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: '1OEqh24L8mtMYkf1j8bAn7Q1GZjPqUrUNuY_ySau_5p4',
                    range: 'Solicitacoes!A2:T',
                });

                if (responseSolicitacoes.result.values) {
                    solicitacoes = responseSolicitacoes.result.values.map((row, index) => ({
                        id: parseInt(row[0]) || index + 1,
                        ano: row[1] || '',
                        mes: row[2] || '',
                        dataSolicitacao: row[3] || '',
                        nomePaciente: row[4] || '',
                        nomeMae: row[5] || '',
                        dataNascimento: row[6] || '',
                        telefone: row[7] || '',
                        canalSolicitacao: row[8] || '',
                        motivo: row[9] || '',
                        docSolicitado: row[10] || '',
                        periodoInicial: row[11] || '',
                        periodoFinal: row[12] || '',
                        requerente: row[13] || '',
                        formaRetirada: row[14] || '',
                        email: row[15] || '',
                        statusSolicitacao: row[16] || '',
                        dataRetirada: row[17] || '',
                        observacao: row[18] || '',
                        loginUsuario: row[19] || 'admin'
                    })).filter(s => s.nomePaciente && s.nomePaciente.trim() !== '');
                }

                // Carregar usu√°rios
                const responseUsuarios = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: '1OEqh24L8mtMYkf1j8bAn7Q1GZjPqUrUNuY_ySau_5p4',
                    range: 'Usuarios!A2:G',
                });

                if (responseUsuarios.result.values) {
                    usuarios = responseUsuarios.result.values.map((row, index) => ({
                        id: parseInt(row[0]) || index + 1,
                        nomeCompleto: row[1] || '',
                        usuario: row[2] || '',
                        senha: row[3] || '',
                        email: row[4] || '',
                        tipo: row[5] || 'user',
                        dataCadastro: row[6] || new Date().toISOString().split('T')[0]
                    })).filter(u => u.usuario && u.usuario.trim() !== '');
                }

                // Salvar dados localmente
                salvarDadosLocais();

                sistemaLogs.adicionarLog('CARREGAR_DADOS_SHEETS', `Carregados ${solicitacoes.length} solicita√ß√µes e ${usuarios.length} usu√°rios`, 'success');
                console.log(`‚úÖ Dados carregados: ${solicitacoes.length} solicita√ß√µes, ${usuarios.length} usu√°rios`);
                
                // Atualizar interface
                preencherListasOpcoes();
                atualizarSelectsFormulario();
                atualizarSelectsFiltros();
                preencherUsuariosHistorico();
                preencherTodosRegistros();
                atualizarTabelaUsuarios();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do Sheets:', error);
                sistemaLogs.adicionarLog('ERRO_CARREGAR_SHEETS', `Erro: ${error.message}`, 'error');
                
                // Tentar carregar dados locais em caso de erro
                carregarDadosLocais();
            }
        }

        // =============================================
        // ATUALIZAR STATUS DA CONEX√ÉO
        // =============================================
        function atualizarStatusConexao(online) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (!statusElement || !textElement) return;
            
            if (online) {
                statusElement.className = 'connection-status connection-online';
                textElement.textContent = 'Conectado ao Google Sheets';
                statusElement.style.display = 'block';
            } else {
                statusElement.className = 'connection-status connection-offline';
                textElement.textContent = 'Modo Offline - Dados Locais';
                statusElement.style.display = 'block';
            }
        }

        // =============================================
        // TESTE DE CONEX√ÉO SIMPLIFICADO
        // =============================================
        async function testarIntegracaoGoogleSheets() {
            mostrarLoading('Testando conex√£o com Google Sheets...');
            
            try {
                if (!gapiInicializado) {
                    await inicializarGoogleAPI();
                }
                
                // Teste simples - tentar acessar a planilha
                await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: '1OEqh24L8mtMYkf1j8bAn7Q1GZjPqUrUNuY_ySau_5p4',
                    range: 'Solicitacoes!A1:A1',
                });
                
                sistemaLogs.adicionarLog('TESTE_CONEXAO', 'Conex√£o com Google Sheets testada com sucesso', 'success');
                mostrarMensagem('‚úÖ Conex√£o com Google Sheets funcionando!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                sistemaLogs.adicionarLog('ERRO_TESTE_CONEXAO', `Erro: ${error.message}`, 'error');
                mostrarMensagem('‚ùå Erro na conex√£o com Google Sheets. Use o modo offline.', 'error');
            } finally {
                esconderLoading();
            }
        }

        // =============================================
        // DADOS INICIAIS DO SISTEMA
        // =============================================
        let usuarios = [
            { id: 1, nomeCompleto: "Administrador", usuario: "admin", senha: "admin123", email: "admin@sistema.com", tipo: "admin", dataCadastro: "2023-01-01" },
            { id: 2, nomeCompleto: "Jo√£o Silva", usuario: "joao.silva", senha: "123456", email: "joao.silva@hospital.com", tipo: "user", dataCadastro: "2023-02-15" },
            { id: 3, nomeCompleto: "Maria Santos", usuario: "maria.santos", senha: "123456", email: "maria.santos@hospital.com", tipo: "user", dataCadastro: "2023-03-10" }
        ];
        
        let opcoesCadastro = {
            canalSolicitacao: ["SITE", "PRESENCIAL"],
            motivo: ["INSS", "DPVAT", "JUDICIAL", "SEGURADORA", "DPVAT / INSS", "2¬∞ OPINI√ÉO", "√ìBITO"],
            docSolicitado: ["COP", "COP + RM", "RM"],
            formaRetirada: ["E-MAIL", "F√çSICO"],
            statusSolicitacao: ["J√Å SOLICITADO", "BAIXANDO", "IMPRIMIR", "ENTREGUE", "NADA CONSTA", "AGUARDANDO RELAT√ìRIO", "FINALIZADO", "AG. PA ARQUIVO", "AG.JADOC"]
        };
        
        let solicitacoes = [
            {
                id: 1,
                ano: "2023",
                mes: "MAIO",
                dataSolicitacao: "2023-05-10",
                nomePaciente: "Maria Oliveira",
                nomeMae: "Ana Oliveira",
                dataNascimento: "1985-03-15",
                telefone: "(11) 99999-9999",
                canalSolicitacao: "SITE",
                motivo: "INSS",
                docSolicitado: "COP",
                periodoInicial: "2023-01-01",
                periodoFinal: "2023-05-10",
                requerente: "Maria Oliveira",
                formaRetirada: "E-MAIL",
                email: "maria.oliveira@email.com",
                statusSolicitacao: "FINALIZADO",
                dataRetirada: "2023-05-15",
                observacao: "Solicita√ß√£o processada com sucesso.",
                loginUsuario: "joao.silva"
            }
        ];
        
        let atividadesUsuario = [
            { id: 1, usuario: "joao.silva", dataHora: "2023-05-10 09:15:00", acao: "Cadastro de Solicita√ß√£o", detalhes: "Solicita√ß√£o #001 para Maria Oliveira" }
        ];

        // Vari√°veis globais
        let usuarioLogado = null;
        let tipoUsuario = null;

        // =============================================
        // FUN√á√ÉO DE LOGIN - CORRIGIDA
        // =============================================
        function fazerLogin(e) {
            e.preventDefault();
            
            const usuarioInput = document.getElementById('loginUser');
            const senhaInput = document.getElementById('loginPassword');
            
            if (!usuarioInput || !senhaInput) {
                mostrarMensagem('‚ùå Campos de login n√£o encontrados', 'error');
                return;
            }
            
            const usuario = usuarioInput.value;
            const senha = senhaInput.value;
            
            // Verificar credenciais
            const usuarioEncontrado = usuarios.find(u => u.usuario === usuario && u.senha === senha);
            
            if (usuarioEncontrado) {
                usuarioLogado = usuarioEncontrado;
                tipoUsuario = usuarioEncontrado.tipo;
                
                // Mostrar sistema e esconder tela de login
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                
                // Configurar event listeners ap√≥s o login
                configurarEventListenersPosLogin();
                
                // Mostrar menu apropriado
                if (tipoUsuario === 'admin') {
                    document.getElementById('userMenu').style.display = 'none';
                    document.getElementById('adminMenu').style.display = 'block';
                } else {
                    document.getElementById('userMenu').style.display = 'block';
                    document.getElementById('adminMenu').style.display = 'none';
                }
                
                // Atualizar informa√ß√µes do usu√°rio
                document.getElementById('userInfo').textContent = `${usuarioLogado.nomeCompleto} (${usuarioLogado.usuario})`;
                
                sistemaLogs.adicionarLog('LOGIN', `Usu√°rio ${usuarioLogado.usuario} fez login`, 'success');
                mostrarMensagem(`‚úÖ Bem-vindo, ${usuarioLogado.nomeCompleto}!`, 'success');
                
            } else {
                sistemaLogs.adicionarLog('TENTATIVA_LOGIN', `Tentativa de login falhou para usu√°rio: ${usuario}`, 'warning');
                mostrarMensagem('‚ùå Usu√°rio ou senha incorretos!', 'error');
            }
        }

        // =============================================
        // CONFIGURAR EVENT LISTENERS AP√ìS LOGIN
        // =============================================
        function configurarEventListenersPosLogin() {
            console.log('üîß Configurando event listeners p√≥s-login...');
            
            // Event Listeners para bot√µes de logout
            const logoutBtn = document.getElementById('logoutBtn');
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            
            if (logoutBtn) logoutBtn.addEventListener('click', fazerLogout);
            if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', fazerLogout);
            
            // Event Listeners para formul√°rios
            const solicitacaoForm = document.getElementById('solicitacaoForm');
            const filtroForm = document.getElementById('filtroForm');
            const cadastroUsuarioForm = document.getElementById('cadastroUsuarioForm');
            const cadastroOpcoesForm = document.getElementById('cadastroOpcoesForm');
            const filtroRelatorioForm = document.getElementById('filtroRelatorioForm');
            
            if (solicitacaoForm) solicitacaoForm.addEventListener('submit', salvarSolicitacao);
            if (filtroForm) filtroForm.addEventListener('submit', pesquisarSolicitacoes);
            if (cadastroUsuarioForm) cadastroUsuarioForm.addEventListener('submit', cadastrarUsuario);
            if (cadastroOpcoesForm) cadastroOpcoesForm.addEventListener('submit', cadastrarOpcao);
            if (filtroRelatorioForm) filtroRelatorioForm.addEventListener('submit', gerarRelatorio);
            
            // Event Listeners para bot√µes
            const gerarHistoricoBtn = document.getElementById('gerarHistoricoBtn');
            const helpBtn = document.getElementById('helpBtn');
            const gerarPDFBtn = document.getElementById('gerarPDFBtn');
            const salvarEdicaoBtn = document.getElementById('salvarEdicaoSolicitacao');
            const periodoHistorico = document.getElementById('periodoHistorico');
            
            if (gerarHistoricoBtn) gerarHistoricoBtn.addEventListener('click', gerarHistoricoUsuario);
            if (helpBtn) helpBtn.addEventListener('click', mostrarAjuda);
            if (gerarPDFBtn) gerarPDFBtn.addEventListener('click', gerarPDF);
            if (salvarEdicaoBtn) salvarEdicaoBtn.addEventListener('click', salvarEdicaoSolicitacao);
            if (periodoHistorico) {
                periodoHistorico.addEventListener('change', function() {
                    document.getElementById('customPeriodo').style.display = 
                        this.value === 'custom' ? 'block' : 'none';
                });
            }
            
            console.log('‚úÖ Event listeners configurados');
        }

        // =============================================
        // FUN√á√ÉO DE LOGOUT
        // =============================================
        function fazerLogout() {
            sistemaLogs.adicionarLog('LOGOUT', `Usu√°rio ${usuarioLogado.usuario} fez logout`, 'info');
            
            usuarioLogado = null;
            tipoUsuario = null;
            
            // Mostrar tela de login e esconder sistema
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainSystem').style.display = 'none';
            
            // Limpar formul√°rio de login
            const loginForm = document.getElementById('loginForm');
            if (loginForm) loginForm.reset();
            
            mostrarMensagem('üëã Logout realizado com sucesso!', 'info');
        }

        // =============================================
        // FUN√á√ïES B√ÅSICAS DO SISTEMA
        // =============================================
        
        function mostrarMensagem(mensagem, tipo) {
            // Criar elemento de mensagem
            const mensagemDiv = document.createElement('div');
            mensagemDiv.className = `alert alert-${tipo === 'error' ? 'danger' : tipo} alert-dismissible fade show alert-custom`;
            mensagemDiv.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Adicionar ao corpo do documento
            document.body.appendChild(mensagemDiv);
            
            // Remover automaticamente ap√≥s 5 segundos
            setTimeout(() => {
                if (mensagemDiv.parentNode) {
                    mensagemDiv.parentNode.removeChild(mensagemDiv);
                }
            }, 5000);
        }

        function atualizarAnoMes() {
            const dataAtual = new Date();
            const ano = dataAtual.getFullYear();
            const meses = [
                "JANEIRO", "FEVEREIRO", "MAR√áO", "ABRIL", "MAIO", "JUNHO",
                "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
            ];
            const mes = meses[dataAtual.getMonth()];
            
            const anoField = document.getElementById('ano');
            const mesField = document.getElementById('mes');
            
            if (anoField) anoField.value = ano;
            if (mesField) mesField.value = mes;
        }

        // [AS DEMAIS FUN√á√ïES DO SISTEMA PERMANECEM AQUI...]
        // Preencha com as fun√ß√µes restantes do seu sistema original

    </script>
</body>
</html>
